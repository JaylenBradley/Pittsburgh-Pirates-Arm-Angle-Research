# Baseball Pitcher Pose Analysis Pipeline

This pipeline processes baseball pitcher video frames through 3 stages: pose detection → pitcher labeling → angle calculation.

## Prerequisites

1. Videos extracted using `extract_video_frames.py` (already done)
2. Frames manually moved to `release_frames/` directories
3. Ground truth CSV file: `~/Desktop/baseball_vids/arm_angles_high_speed.csv`
4. Working ViTPose and MMDetection installation

## Pipeline Overview

```
~/Desktop/baseball_vids/
├── VIDEO_ID/
│   ├── all_frames/          (from extract_video_frames.py)
│   ├── release_frames/      (manually curated frames)
│   ├── poses/               (generated by process_release_frames.py)
│   │   └── frame_XXXX_poses/
│   │       ├── data.json
│   │       └── frame_XXXX_poses.jpg
│   ├── pitcher_labels/      (generated by label_pitchers.py)
│   │   └── frame_XXXX_pitcher/
│   │       ├── data.json
│   │       └── frame_XXXX_pitcher.jpg
│   └── pitcher_calculations/ (generated by calculate_pitcher_angles.py)
│       └── frame_XXXX_angle/
│           ├── data.json
│           └── frame_XXXX_angle.jpg
└── arm_angles_high_speed.csv
```

## Setup

1. **Copy all 4 Python files to `/Users/jaylen/Developer/Research/Pirates_Arm_Angle/scripts/`:**
   - `pose_utils.py`
   - `process_release_frames.py`
   - `label_pitchers.py`
   - `calculate_pitcher_angles.py`

2. **Place ground truth CSV** at `~/Desktop/baseball_vids/arm_angles_high_speed.csv`

## Usage

Run from the `Pirates_Arm_Angle` directory (not from scripts/):

### Stage 1: Extract Pose Data

Process all frames in `release_frames/` to detect persons and extract 133 keypoints:

```bash
python scripts/process_release_frames.py
```

Options:
- `--videos-dir PATH` - Custom path to baseball_vids directory
- `--force` - Reprocess already-processed frames
- `--device cpu` - Device for inference (cpu or cuda:0)

### Stage 2: Label Pitchers (Interactive)

Interactively select which detected person is the pitcher:

```bash
python scripts/label_pitchers.py
```

**Controls:**
- **Click** on a person's image to select them
- **Press 1-9** to select person by number
- **Press 0 or n** to mark "no pitcher detected"
- **Press s** to skip current frame
- **Press q** to quit

Options:
- `--videos-dir PATH` - Custom path to baseball_vids directory
- `--force` - Reprocess already-labeled frames

### Stage 3: Calculate Angles

Calculate arm angles and compare to ground truth:

```bash
python scripts/calculate_pitcher_angles.py
```

Options:
- `--videos-dir PATH` - Custom path to baseball_vids directory
- `--csv PATH` - Path to ground truth CSV (default: baseball_vids/arm_angles_high_speed.csv)
- `--start-joint shoulder|elbow` - Joint to start angle from (default: shoulder)
- `--force` - Reprocess already-calculated frames

**To calculate elbow-to-wrist angles instead:**
```bash
python scripts/calculate_pitcher_angles.py --start-joint elbow
```

## Output Files

### poses/ - Raw pose detection data
- `data.json`: All detected persons with 133 keypoints each
- `frame_XXXX_poses.jpg`: Visualization with all detected poses

### pitcher_labels/ - Pitcher-specific data
- `data.json`: Selected pitcher's data (person_id, bbox, keypoints)
- `frame_XXXX_pitcher.jpg`: Cropped pitcher image with keypoints

### pitcher_calculations/ - Angle calculations
- `data.json`: Predicted angle, ground truth, error, keypoint positions
- `frame_XXXX_angle.jpg`: Visualization with angle vectors and error

## Workflow

1. **Extract frames** (already done):
   ```bash
   python scripts/extract_video_frames.py
   ```

2. **Manually move frames** from `all_frames/` to `release_frames/` for each video

3. **Run the 3-stage pipeline:**
   ```bash
   # Stage 1: Detect poses
   python scripts/process_release_frames.py
   
   # Stage 2: Label pitchers (interactive)
   python scripts/label_pitchers.py
   
   # Stage 3: Calculate angles
   python scripts/calculate_pitcher_angles.py
   ```

4. **Review results** in `pitcher_calculations/` directories

## Skipping Already-Processed Frames

All scripts automatically skip frames that have already been processed. Each script checks for the existence of the output `data.json` file before processing.

To force reprocessing:
```bash
python scripts/process_release_frames.py --force
python scripts/label_pitchers.py --force
python scripts/calculate_pitcher_angles.py --force
```

## No Pitcher Detected

If you mark a frame as "no pitcher detected" in Stage 2:
- A minimal JSON is created in `pitcher_labels/`
- Stage 3 automatically skips these frames
- They won't affect error calculations

## Troubleshooting

**"Poses data not found" in Stage 2:**
- Run Stage 1 first: `python scripts/process_release_frames.py`

**"Pitcher labels not found" in Stage 3:**
- Run Stage 2 first: `python scripts/label_pitchers.py`

**"No ground truth found for video":**
- Make sure video ID in baseball_vids matches PitchId in CSV
- Check CSV path: `~/Desktop/baseball_vids/arm_angles_high_speed.csv`

**Import errors:**
- Make sure you're running from `Pirates_Arm_Angle` directory (not scripts/)
- Check that `pose_utils.py` is in the scripts/ directory
- Ensure ViTPose and MMDetection are installed

## Notes

- All scripts process ALL videos in baseball_vids automatically
- Only frames in `release_frames/` are processed (manually curated)
- Frame naming follows pattern: `frame_XXXX → frame_XXXX_poses → frame_XXXX_pitcher → frame_XXXX_angle`
- CSV PitcherHand (R/L) determines which arm to analyze
- Default angle calculation is shoulder-to-wrist (use `--start-joint elbow` for elbow-to-wrist)
